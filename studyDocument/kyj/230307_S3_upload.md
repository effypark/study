# S3 upload

AWS 설정
S3 생성 및 설정
별다른 셋팅 없이 리전만 잘 골라서 만들면 된다.

## 액세스 권한을 부여하는 IAM 정책 생성 방법
IAM 설정이란?
IAM(AWS Identity and Access Management)은 AWS 리소스에 대한 액세스를 안전하게 제어할 수 있는 웹 서비스를 말합니다.

### 사용자 권한 추가  
1. 사용자 선택  
AWS 관리 콘솔에서 IAM을 선택하고, 대시보드에서 사용자를 선택합니다.   
2. 사용자 권한 추가 선택  
Captain 사용자를 선택하고, 사용자 권한 추가합니다.  
3. 기존 정책 직접연결 선택  
captain 사용자에 기존 정책 직접 연결을 선택합니다. captain에 "AdministratorAccess" 권한을 부여합니다.  

4. 정책 JSON 확인  
정책을 연결하고 사용자에서 Captain을 선택하고, JSON 파일을 확인합니다.  

[ARN 버킷 이름 및 리소스 경로 지정](https://inpa.tistory.com/entry/AWS-%F0%9F%93%9A-IAM-Policy-JSON-%EA%B5%AC%EC%A1%B0-ARN-%EB%AC%B8%EB%B2%95-%EC%A0%95%EB%A6%AC)
```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "VisualEditor0",  // Statement ID로 statement 를 구분하기 위해서 사용
            "Effect": "Allow",       // 해당 설정 적용을 Allow / Deny
            "Action": [              // 허용할 행위(액션)
                "s3:PutObject",      // 객체 업로드
                "s3:GetObject",      // 객체 가져오기
                "s3:DeleteObject"    // 객체 삭제
            ],
            "Resource": [            // Action이 영향을 미치는 리소스 리스트를 지정
                "arn:aws:s3:::버킷이름",
                "arn:aws:s3:::버킷이름/*"
            ]
        }
    ]
}
```
5. 정책 시뮬레이션 확인  
정책 시뮬레이션을 선택합니다.  

## S3 CORS 설정
```
 Amazon S3 → 버킷 → 해당 버킷 → 권한 → CORS
```
클라이언트에서 바로 올리려면 CORS 설정이 필요합니다.
설정하지 않고 presigned url로 업로드 하면 CORS 에러가 발생합니다.
```
[
    {
        "AllowedHeaders": [
            "*"
        ],
        "AllowedMethods": [
            "PUT",
            "POST",
            "DELETE"
        ],
        "AllowedOrigins": [ //접근 허용할 도메인
            "http://localhost:3000"
        ],
        "ExposeHeaders": []
    }
]
```

## .env 파일 설정
```
#aws iam 작성 시 나오는 액세스 키와 시크릿 키
MY_AWS_ACCESS_KEY = "[aws iam 키]"
MY_AWS_SECRET_KEY = "[aws iam 시크릿 키]"

#버킷 이름
MY_AWS_S3_BUCKET = "[버킷이름]"

#버킷 리전
MY_AWS_S3_BUCKET_REGION = "ap-northeast-2"
```

## 사용
```
// Import required AWS SDK clients and commands for Node.js.
import { ListBucketsCommand } from "@aws-sdk/client-s3";
import { s3Client } from "./libs/s3Client.js"; // Helper function that creates an Amazon S3 service client module.

export const run = async () => {
  try {
    const data = await s3Client.send(new ListBucketsCommand({}));
    console.log("Success", data.Buckets);
    return data; // For unit tests.
  } catch (err) {
    console.log("Error", err);
  }
};
run();
```

[참조]
[S3](https://docs.aws.amazon.com/ko_kr/sdk-for-javascript/v3/developer-guide/s3-example-creating-buckets.html)