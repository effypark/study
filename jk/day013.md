# python query set

## 어려움

코드
```python
(Model.objects
  .filter(조건절)
  .select_related('정방향_참조_필드')   # 해당 필드를 join해서 가져온다.
  .prefetch_related('역방향_참조_필드') # 해당 필드는 추가쿼리로 가져온다.
)
```

실행 예측
```
select * from 'Model' m
(inner OR left outer) join '정방향_참조_필드' r on m.r_id=r.id 
'where '조건절';
select * from '역방향_참조_필드' where id in ('첫번째 쿼리 결과의 id 리스트');
```

하지만 100% 의도대로 실행되지 않는다.

select_related 는 join
prefetch_related 는 n+1 일 경우 사용한다.(jpa의 FetchType 적용인건가?)

그러나 QuerySet이 코드에서 불필요한 옵션이라고 판단되면
개발자의 의도를 무시하고 query를 작성한다(?)

```python
(OrderedProduct.objects
 .filter(id=1, related_order__descriptions='sdfsdf')
 #.select_related('related_order'))
```
```
SELECT *
    FROM "orm_practice_app_orderedproduct" 
    INNER JOIN "orm_practice_app_order" 
        ON ("orm_practice_app_orderedproduct"."related_order_id" = "orm_practice_app_order"."id")
    WHERE ("orm_practice_app_orderedproduct"."id" = 1 AND "orm_practice_app_order"."descriptions" = '주문의 상세내용입니다...1')
```

위 처럼 select_related를 사용하지 않아도 필요하다고 판단되면 join한다
(jpa는 entity에서도 미리 설정해놓으면 join한다. 이건 설정없이 join되는건가?)


prefetch_related()와 함께 불필요한 JOIN이 발생하는 경우
아래와 같은 경우는 문제가 없다.
```
# product_set을 prefetched_related로 가져오는 쿼리셋 선언
company_queryset: QuerySet = Company.objects.prefetch_related('product_set').filter(name='company_name1')
# 쿼리셋을 수행하면 아래와 같은 쿼리 2개 발생 (문제 없음)
comapny_list: List[Company]= list(company_queryset)
 """
  SELECT "orm_practice_app_company"."id", "orm_practice_app_company"."name", "orm_practice_app_company"."tel_num", "orm_practice_app_company"."address" 
      FROM "orm_practice_app_company" 
          WHERE "orm_practice_app_company"."name" = 'company_name1';
  
  -- prefetch_related() 구절이 아래 SQL을 부른다 --       
  SELECT "orm_practice_app_product"."id", "orm_practice_app_product"."name", "orm_practice_app_product"."price", "orm_practice_app_product"."product_owned_company_id" 
      FROM "orm_practice_app_product" 
          WHERE "orm_practice_app_product"."product_owned_company_id" IN (1, 21);
 """
```


하지만 아래와 같이 조건절을 하나만 더 추가한 경우는 어떻게 될까?

이 경우는 prefetch_related()를 사용했음에도 불구하고
QuerySet이 Join으로 데이터를 조회한다.

```
# 이런 경우 문제가 발생한다
# 하지만?
company_queryset: QuerySet = Company.objects.prefetch_related('product_set').filter(name='company_name1', product__name='product_name3')
# 이렇게 product관련 조건절이 한개 더 추가된다면 어떨까
# 쿼리셋을 수행하면 아래와 같은 잘못된 쿼리가 발생한다.
comapny_list: List[Company] = list(company_queryset)
"""
  SELECT "orm_practice_app_company"."id", "orm_practice_app_company"."name", "orm_practice_app_company"."tel_num", "orm_practice_app_company"."address" 
      FROM "orm_practice_app_company"
          INNER JOIN "orm_practice_app_product" ON ("orm_practice_app_company"."id" = "orm_practice_app_product"."product_owned_company_id") 
          --여기서 join이 발생했으면 join으로 product row를 다 조회 하는게 맞는데 join을 통해 조건절 검사만하고 --
          -- 두번째 쿼리에서 product를 한번 더 조회한다 --
      WHERE ("orm_practice_app_company"."name" = 'company_name1' AND "orm_practice_app_product"."name" = 'product_name3')  LIMIT 21;
  
  -- prefetch_related옵션으로 인해 해당 쿼리가 발생 -> 결과적으로 product를 불필요하게 2번 조회함 --
  SELECT "orm_practice_app_product"."id", "orm_practice_app_product"."name", "orm_practice_app_product"."price", "orm_practice_app_product"."product_owned_company_id" 
      FROM "orm_practice_app_product" 
  WHERE "orm_practice_app_product"."product_owned_company_id" IN (1);
"""
# 이런 경우는 
# 1. prefetch_related('product_set') 이 구절을 제거하거나  (Inner Join 만 발생)
```
첫 쿼리에서 Product(orm_proactice_app_product)를 Join 했음에도 불구하고
추가 쿼리에서 한번더 Product를 조회한다.

이런 경우는
주석에 작성한 것처럼 1,2 중 한가지 방법을 택해서 수정해야한다.

*추가정보: 정방향 참조된 모델들도 prefetch_related()를 통해 join이 아닌 추가 쿼리로 가져올수는 있다.


