# django query 최적화

0. 먼저 프로파일링부터  

DB 액세스나 쿼리를 최적화하기 전에 해당 쿼리와 그에 대한  
비용에 대해 알아보는 게 중요합니다.

QuerySet이 데이터베이스에 의해서 어떻게 실행되는지 이해하려면  
QuerySet.explain()을 사용하면 됩니다.

django-debug-toolbar와 같은 외부 프로젝트나 데이터베이스를  
직접 모니터링하는 도구를 사용할 수도 있습니다.

1. 보편적인 DB 최적화 기법 사용하기

인덱스: Django에서는 Field.db_index 또는  
Meta.index_together를 사용하여 추가할 수 있습니다.  
filter(), exclude(), order_by() 등을 사용하여  
자주 쿼리하는 필드에 인덱스를 추가하는 것이 좋습니다.  
인덱스를 사용하면 조회 속도를 높이는 데 도움이 됩니다.  
하지만 인덱스를 너무 남발하게 될 경우, 인덱스를 유지하는 비용이  
인덱스를 사용해 속도를 높인 쿼리의 성능보다 클 수 있기 때문에  
신중하게 결정해야 합니다.

적절한 필드 타입 사용

2. QuerySet 이해하기

QuerySet을 이해하는 것은 간단한 코드로 좋은 성능을 얻는 데 특히 중요합니다.

2-1. QuerySet 계산 이해하기

성능 문제를 피하려면 다음을 이해하는 게 중요합니다.

QuerySet은 게으르다(lazy)  
QuerySet을 생성하는 행위는 데이터베이스 활동을 포함하지 않습니다.  
Django는 QuerySet이 계산될 때까지 실제로 쿼리를 실행하지 않습니다.   
실제로 계산되는 시점은 아래에서 더 자세하게 다룹니다.

QuerySet이 계산되는 시점

QuerySet은 다음과 같은 시점에 계산됩니다:  
반복 (Iteration), 슬라이싱 (Slicing),   
피클링 / 캐싱 (Pickling/Caching), repr(), len(), list(), bool()

데이터가 메모리에 저장되는 방식

각 QuerySet에는 데이터베이스 액세스를 최소화하기 위한   
캐시가 포함되어 있습니다. 이것이 어떻게 작동하는지 이해하면   
효율적인 코드를 작성하는 데 도움이 됩니다.

2-2. 캐시된 속성 이해하기

전체 QuerySet 캐싱 뿐만 아니라 ORM 객체에 대한  
속성 결과 캐싱도 있습니다. 일반적으로 호출할 수 없는 속성은 캐싱됩니다.  
예를 들어 Weblog 모델 예제를 보면 다음과 같습니다:

> entry = Entry.objects.get(id=1)
> entry.blog   # Blog 객체가 여기서 검색된다
> entry.blog   # 캐시되었기 때문에 여기서는 DB 액세스가 일어나지 않는다  

그러나 일반적으로 호출 가능한 속성은 매번 DB 조회를 발생시킵니다.

> entry = Entry.objects.get(id=1)
> entry.authors.all()   # 쿼리 실행
> entry.authors.all()   # 또다시 쿼리 실행

2-3. with 템플릿 태그 사용하기

QuerySet의 캐싱 동작을 사용하려면 with 템플릿 태그를 사용해야 할 수도 있습니다.

with 템플릿 태그는 복잡한 변수를 더 간단한 이름으로 저장합니다.

이는 비용이 많이 드는 방법 (EX. 데이터베이스를 조회하는 방법)에   
여러 번 액세스 할 때 유용합니다.

2-4. iterator() 사용하기

객체가 많은 경우 QuerySet의 캐싱 동작으로 인해  
많은 양의 메모리가 사용될 수 있습니다. 이 경우 iterator()가 도움이 될 수 있습니다.  
한 번 액세스 해야하는 많은 수의 객체를 반환하는 QuerySet의 경우,  
성능이 향상되고 메모리가 크게 감소할 수 있습니다.

2-5. explain() 사용하기

맨 처음 프로파일링 부분에서도 언급했지만,   
QuerySet.explain()은 사용된 인덱스 및 조인을 포함하여   
데이터베이스에서 쿼리를 실행하는 방법에 대한 자세한 정보를 제공합니다.   
이러한 세부 정보는 보다 효율적으로 다시 작성할 수 있는 쿼리를 찾거나   
성능을 향상시키기 위해 추가할 수있는 인덱스를 식별하는 데 도움이 될 수 있습니다.

3. Python이 아닌 데이터베이스에서 작동하는 경우

예를 들어,

filter() 및 exclude()를 사용하여 데이터베이스에서 필터링하는 경우  
F 표현식을 사용하여 같은 모델의 다른 필드를 기반으로 필터링하는 경우  
데이터베이스에서 aggregation을 하기 위해 어노테이션하는 경우  
다음과 같이 필요한 SQL을 생성하기에 충분하지 않은 경우에는 다음과 같은 방법이 있습니다.  

RawSQL 사용하기  

일부 SQL을 쿼리에 명시적으로 추가할 수 있습니다.

raw SQL 사용하기

그래도 부족할 경우, 완전하게 raw SQL를 사용할 수도 있습니다.